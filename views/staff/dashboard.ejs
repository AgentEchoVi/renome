<%
  const L = lang === 'ru' ? {
    online: 'Онлайн',
    connecting: 'Подключение...',
    reconnecting: 'Переподключение...',
    logout: 'Выйти',
    ordersToday: 'заказов сегодня',
    revenue: 'выручка',
    waiting: 'Ожидание новых заказов...',
    willNotify: 'Вы получите уведомление',
    delivery: 'Доставка',
    pickup: 'Самовывоз',
    cash: 'Наличные',
    card: 'Карта',
    total: 'Итого',
    enableNotif: 'Включите уведомления, чтобы не пропустить заказы',
    enable: 'Включить',
    later: 'Позже',
    newOrder: 'Новый заказ',
    statusNew: 'Новый',
    statusConfirmed: 'Принят',
    statusCompleted: 'Завершён',
    statusCancelled: 'Отменён',
    accept: 'Принять',
    complete: 'Завершить',
    cancel: 'Отменить',
    edit: 'Изменить',
    save: 'Сохранить',
    close: 'Закрыть',
    cancelOrder: 'Отмена заказа',
    cancelReason: 'Причина отмены (необязательно)',
    confirmCancel: 'Подтвердить отмену',
    editOrder: 'Редактировать заказ',
    name: 'Имя',
    phone: 'Телефон',
    address: 'Адрес',
    comment: 'Комментарий',
    items: 'Позиции',
    reason: 'Причина',
    history: 'История',
    historyStatus: 'Статус изменён',
    historyItems: 'Позиции изменены',
    historyCustomer: 'Данные клиента изменены'
  } : {
    online: 'Online',
    connecting: 'Conectare...',
    reconnecting: 'Reconectare...',
    logout: 'Ieșire',
    ordersToday: 'comenzi azi',
    revenue: 'venit',
    waiting: 'Așteptarea comenzilor noi...',
    willNotify: 'Veți primi o notificare',
    delivery: 'Livrare',
    pickup: 'Ridicare',
    cash: 'Numerar',
    card: 'Card',
    total: 'Total',
    enableNotif: 'Activați notificările pentru a nu rata comenzile',
    enable: 'Activați',
    later: 'Mai târziu',
    newOrder: 'Comandă nouă',
    statusNew: 'Nou',
    statusConfirmed: 'Confirmat',
    statusCompleted: 'Finalizat',
    statusCancelled: 'Anulat',
    accept: 'Acceptă',
    complete: 'Finalizează',
    cancel: 'Anulează',
    edit: 'Editează',
    save: 'Salvează',
    close: 'Închide',
    cancelOrder: 'Anulare comandă',
    cancelReason: 'Motivul anulării (opțional)',
    confirmCancel: 'Confirmă anularea',
    editOrder: 'Editare comandă',
    name: 'Nume',
    phone: 'Telefon',
    address: 'Adresă',
    comment: 'Comentariu',
    items: 'Poziții',
    reason: 'Motiv',
    history: 'Istoric',
    historyStatus: 'Status schimbat',
    historyItems: 'Poziții modificate',
    historyCustomer: 'Date client modificate'
  };

  const statusLabels = {
    'new': L.statusNew,
    'confirmed': L.statusConfirmed,
    'completed': L.statusCompleted,
    'cancelled': L.statusCancelled
  };
%>
<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0D0D0D">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Staff — Renome</title>
  <link rel="manifest" href="/manifest-staff.json">
  <link rel="icon" href="/img/logo.png">
  <link rel="apple-touch-icon" href="/img/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/staff.css?v=3">
</head>
<body class="staff-body">

  <!-- Top bar -->
  <header class="staff-topbar">
    <div class="staff-topbar__left">
      <span class="staff-topbar__logo">RENOME</span>
      <span class="staff-topbar__label">Staff</span>
    </div>
    <div class="staff-topbar__right">
      <div class="staff-lang">
        <a href="/set-lang?lang=ro&redirect=/staff" class="staff-lang__btn<%= lang === 'ro' ? ' staff-lang__btn--active' : '' %>">RO</a>
        <a href="/set-lang?lang=ru&redirect=/staff" class="staff-lang__btn<%= lang === 'ru' ? ' staff-lang__btn--active' : '' %>">RU</a>
      </div>
      <span class="staff-status" id="sseStatus">
        <span class="staff-status__dot"></span>
        <span class="staff-status__text"><%= L.connecting %></span>
      </span>
      <a href="/staff/logout" class="staff-topbar__logout"><%= L.logout %></a>
    </div>
  </header>

  <!-- Stats -->
  <div class="staff-stats">
    <div class="staff-stats__item">
      <span class="staff-stats__value" id="orderCount"><%= orders.length %></span>
      <span class="staff-stats__label"><%= L.ordersToday %></span>
    </div>
    <div class="staff-stats__item">
      <span class="staff-stats__value" id="orderTotal"><%= orders.reduce((s, o) => s + o.total, 0) %> MDL</span>
      <span class="staff-stats__label"><%= L.revenue %></span>
    </div>
  </div>

  <!-- Orders -->
  <main class="staff-orders" id="ordersContainer">

    <% if (orders.length === 0) { %>
      <div class="staff-empty" id="emptyState">
        <div class="staff-empty__icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </div>
        <p class="staff-empty__text"><%= L.waiting %></p>
        <p class="staff-empty__sub"><%= L.willNotify %></p>
      </div>
    <% } %>

    <% orders.forEach(order => { %>
      <% const st = order.status || 'new'; %>
      <div class="staff-order-card<%= st === 'completed' ? ' staff-order-card--completed' : '' %><%= st === 'cancelled' ? ' staff-order-card--cancelled' : '' %>" data-order-id="<%= order.id %>" data-status="<%= st %>">
        <div class="staff-order-card__header">
          <div style="display:flex;align-items:center;gap:8px">
            <span class="staff-order-card__id">#<%= order.id %></span>
            <span class="staff-status-badge staff-status-badge--<%= st %>"><%= statusLabels[st] || st %></span>
          </div>
          <span class="staff-order-card__time"><%= new Date(order.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}) %></span>
        </div>

        <div class="staff-order-card__customer">
          <div>
            <div class="staff-order-card__name"><%= order.customer_name %></div>
            <% if (order.customer_email) { %>
              <div class="staff-order-card__email"><%= order.customer_email %></div>
            <% } %>
          </div>
          <a href="tel:<%= order.customer_phone %>" class="staff-order-card__phone"><%= order.customer_phone %></a>
        </div>

        <div class="staff-order-card__type">
          <span class="staff-badge staff-badge--<%= order.delivery_type %>">
            <%= order.delivery_type === 'delivery' ? L.delivery : L.pickup %>
          </span>
          <span class="staff-badge staff-badge--payment">
            <%= order.payment_method === 'cash' ? L.cash : L.card %>
          </span>
        </div>

        <% if (order.delivery_address) { %>
          <div class="staff-order-card__address">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <%= order.delivery_address %>
          </div>
        <% } %>

        <div class="staff-order-card__items">
          <% order.items.forEach(item => { %>
            <div class="staff-item-row" data-item-id="<%= item.id %>">
              <span class="staff-item-row__qty"><%= item.quantity %>x</span>
              <span class="staff-item-row__name"><%= item.name %></span>
              <span class="staff-item-row__price"><%= item.price * item.quantity %> MDL</span>
            </div>
          <% }) %>
        </div>

        <% if (order.comment) { %>
          <div class="staff-order-card__comment">"<%= order.comment %>"</div>
        <% } %>

        <% if (st === 'cancelled' && order.cancel_reason) { %>
          <div class="staff-order-card__cancel-reason"><%= L.reason %>: <%= order.cancel_reason %></div>
        <% } %>

        <% if (order.history && order.history.length > 0) { %>
          <div class="staff-history">
            <button class="staff-history__toggle" onclick="staffActions.toggleHistory(this)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <%= L.history %> (<%= order.history.length %>)
              <svg class="staff-history__chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="staff-history__timeline" style="display:none">
              <% order.history.forEach(h => { %>
                <div class="staff-history__entry staff-history__entry--<%= h.action %>">
                  <div class="staff-history__dot"></div>
                  <div class="staff-history__content">
                    <div class="staff-history__action">
                      <% if (h.action === 'status_change') { %>
                        <% const d = JSON.parse(h.details); %>
                        <%= L.historyStatus %>: <%= statusLabels[d.from] || d.from %> &rarr; <%= statusLabels[d.to] || d.to %>
                      <% } else if (h.action === 'item_edit') { %>
                        <%= L.historyItems %>
                      <% } else if (h.action === 'customer_edit') { %>
                        <%= L.historyCustomer %>
                      <% } %>
                    </div>
                    <div class="staff-history__meta">
                      <%= h.staff_name %> &middot; <%= new Date(h.created_at).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}) %>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (st === 'new' || st === 'confirmed') { %>
          <div class="staff-actions">
            <% if (st === 'new') { %>
              <button class="staff-action-btn staff-action-btn--accept" onclick="staffActions.accept(<%= order.id %>)"><%= L.accept %></button>
            <% } else { %>
              <button class="staff-action-btn staff-action-btn--complete" onclick="staffActions.complete(<%= order.id %>)"><%= L.complete %></button>
            <% } %>
            <button class="staff-action-btn staff-action-btn--cancel" onclick="staffActions.openCancel(<%= order.id %>)"><%= L.cancel %></button>
            <button class="staff-action-btn staff-action-btn--edit" onclick="staffActions.openEdit(<%= order.id %>)"><%= L.edit %></button>
          </div>
        <% } %>

        <div class="staff-order-card__total">
          <span><%= L.total %></span>
          <span><%= order.total %> MDL</span>
        </div>
      </div>
    <% }) %>

  </main>

  <!-- Cancel Modal -->
  <div class="staff-modal" id="cancelModal">
    <div class="staff-modal__overlay" onclick="staffActions.closeCancel()"></div>
    <div class="staff-modal__sheet">
      <div class="staff-modal__title"><%= L.cancelOrder %></div>
      <div class="staff-modal__field">
        <label class="staff-modal__label"><%= L.cancelReason %></label>
        <textarea class="staff-modal__input" id="cancelReason" rows="3"></textarea>
      </div>
      <div class="staff-modal__actions">
        <button class="staff-modal__btn staff-modal__btn--secondary" onclick="staffActions.closeCancel()"><%= L.close %></button>
        <button class="staff-modal__btn staff-modal__btn--danger" id="confirmCancelBtn"><%= L.confirmCancel %></button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="staff-modal" id="editModal">
    <div class="staff-modal__overlay" onclick="staffActions.closeEdit()"></div>
    <div class="staff-modal__sheet">
      <div class="staff-modal__title"><%= L.editOrder %> <span id="editOrderId"></span></div>
      <div class="staff-modal__field">
        <label class="staff-modal__label"><%= L.name %></label>
        <input type="text" class="staff-modal__input" id="editName">
      </div>
      <div class="staff-modal__field">
        <label class="staff-modal__label"><%= L.phone %></label>
        <input type="tel" class="staff-modal__input" id="editPhone">
      </div>
      <div class="staff-modal__field">
        <label class="staff-modal__label"><%= L.address %></label>
        <input type="text" class="staff-modal__input" id="editAddress">
      </div>
      <div class="staff-modal__field">
        <label class="staff-modal__label"><%= L.comment %></label>
        <textarea class="staff-modal__input" id="editComment" rows="2"></textarea>
      </div>
      <div class="staff-edit-items">
        <div class="staff-edit-items__title"><%= L.items %></div>
        <div id="editItemsList"></div>
      </div>
      <div class="staff-modal__actions">
        <button class="staff-modal__btn staff-modal__btn--secondary" onclick="staffActions.closeEdit()"><%= L.close %></button>
        <button class="staff-modal__btn staff-modal__btn--primary" id="saveEditBtn"><%= L.save %></button>
      </div>
    </div>
  </div>

  <!-- Notification permission banner -->
  <div class="staff-notify-banner" id="notifyBanner" style="display:none">
    <span><%= L.enableNotif %></span>
    <button class="staff-notify-btn" id="enableNotifyBtn"><%= L.enable %></button>
    <button class="staff-notify-dismiss" id="dismissNotifyBtn"><%= L.later %></button>
  </div>

  <script>
    window.STAFF_LANG = '<%= lang %>';
    window.STAFF_T = <%- JSON.stringify(L) %>;
  </script>
  <script src="/js/staff.js?v=6"></script>
</body>
</html>
